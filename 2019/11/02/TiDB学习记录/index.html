<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  

  
  <title>TiDB学习记录 | Try Everything</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="TiDB追番记录1.很有帮助的几个网站 官方文档：https://pingcap.com/docs-cn/v3.0/  完整准确的学习指南，可以了解到原理，部署，指南，版本历程等所有和TiDB相关的一切，有疑问或者遇到问题的时候，右上角搜索能解决大部分的问题，有问题先查官方文档～～～   TUG文档社区：https://asktug.com/  TiDB User Group 成员共同建立的问答社">
<meta name="keywords" content="TiDB">
<meta property="og:type" content="article">
<meta property="og:title" content="TiDB学习记录">
<meta property="og:url" content="http://sandysandy.github.io/2019/11/02/TiDB学习记录/index.html">
<meta property="og:site_name" content="Try Everything">
<meta property="og:description" content="TiDB追番记录1.很有帮助的几个网站 官方文档：https://pingcap.com/docs-cn/v3.0/  完整准确的学习指南，可以了解到原理，部署，指南，版本历程等所有和TiDB相关的一切，有疑问或者遇到问题的时候，右上角搜索能解决大部分的问题，有问题先查官方文档～～～   TUG文档社区：https://asktug.com/  TiDB User Group 成员共同建立的问答社">
<meta property="og:locale" content="en,zh-cn">
<meta property="og:updated_time" content="2019-11-01T08:41:05.983Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="TiDB学习记录">
<meta name="twitter:description" content="TiDB追番记录1.很有帮助的几个网站 官方文档：https://pingcap.com/docs-cn/v3.0/  完整准确的学习指南，可以了解到原理，部署，指南，版本历程等所有和TiDB相关的一切，有疑问或者遇到问题的时候，右上角搜索能解决大部分的问题，有问题先查官方文档～～～   TUG文档社区：https://asktug.com/  TiDB User Group 成员共同建立的问答社">
  
    <link rel="alternate" href="/atom.xml" title="Try Everything" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Try Everything</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">just move it</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://sandysandy.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-TiDB学习记录" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/11/02/TiDB学习记录/" class="article-date">
  <time datetime="2019-11-01T16:39:59.000Z" itemprop="datePublished">2019-11-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      TiDB学习记录
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="TiDB追番记录"><a href="#TiDB追番记录" class="headerlink" title="TiDB追番记录"></a>TiDB追番记录</h2><h3 id="1-很有帮助的几个网站"><a href="#1-很有帮助的几个网站" class="headerlink" title="1.很有帮助的几个网站"></a>1.很有帮助的几个网站</h3><ul>
<li><p>官方文档：<a href="https://pingcap.com/docs-cn/v3.0/" target="_blank" rel="noopener">https://pingcap.com/docs-cn/v3.0/</a></p>
<ul>
<li>完整准确的学习指南，可以了解到原理，部署，指南，版本历程等所有和TiDB相关的一切，有疑问或者遇到问题的时候，右上角搜索能解决大部分的问题，有问题先查官方文档～～～</li>
</ul>
</li>
<li><p>TUG文档社区：<a href="https://asktug.com/" target="_blank" rel="noopener">https://asktug.com/</a></p>
<ul>
<li>TiDB User Group 成员共同建立的问答社区网站，有问题查完官方文档，再来这里搜一搜，基本能解决大部分的问题啦～</li>
</ul>
</li>
<li><p>实战案例：<a href="https://pingcap.com/cases-cn/" target="_blank" rel="noopener">https://pingcap.com/cases-cn/</a></p>
<ul>
<li>可以看到分享案例，了解不同场景下的处理方案和调整过程，学习解决问题的思路～</li>
</ul>
</li>
<li><p>官方分享视频：<a href="https://space.bilibili.com/86485707" target="_blank" rel="noopener">https://space.bilibili.com/86485707</a></p>
<ul>
<li>Meetup活动视频，Paper Reading，官方活动直播，B站认证账号哦，是的，没错，好好学习在B站～～～</li>
</ul>
</li>
<li><p>成为参与者：<a href="https://pingcap.com/community-cn/" target="_blank" rel="noopener">https://pingcap.com/community-cn/</a></p>
<ul>
<li>回馈开源社区</li>
</ul>
</li>
<li><p>TiDB-OPS：<a href="https://docs.tidb.cc/" target="_blank" rel="noopener">https://docs.tidb.cc/</a></p>
<ul>
<li>白盒内容：围绕 TiDB 为中心测试记录、运维总结；</li>
<li>黑盒分析请看 <a href="https://bbs.tidb.cc" target="_blank" rel="noopener">https://bbs.tidb.cc</a></li>
</ul>
</li>
</ul>
<h3 id="2-部署tips"><a href="#2-部署tips" class="headerlink" title="2.部署tips"></a>2.部署tips</h3><p>以下描述基于V3.0.3版本，目标是常规部署适用，按照详细的官方文档指导步骤操作即可，每一步如果有问题，一定解决掉再进行下一步～</p>
<ul>
<li><p>服务器前置条件注意互信配置，ntp，cpu调度设置，磁盘格式</p>
</li>
<li><p>inventory.ini 文件内容建议每个作用域别名指定实例，方便识别及监控数据对应，举2个具体的🌰</p>
<ul>
<li><p>tidb节点</p>
<pre><code>1.别名tidb-1，
2.节点IP，默认端口号4000，如果同一台服务器，多节点部署，可以指定其他端口号
3.部署路径，默认全局统一部署路径，也可以根据服务器配置指定不同部署路径

eg:
[tidb_servers]
tidb-1 ansible_host=x.x.x.x deploy_dir=/xxx/xxx</code></pre></li>
<li><p>tikv节点</p>
<pre><code>1.别名tidb-1，
2.节点IP，默认端口号20160，状态端口号20180，如果同一台服务器，多节点部署，可以指定其他端口号。另外，如果kv节点单服务器多实例部署，注意调节conf/tikv.toml CPU和内存资源分配，详情见官方文档说明
3.部署路径，默认全局统一部署路径，也可以根据服务器配置指定不同部署路径
4.labels信息，指定服务器的物理位置，作用在于多数据中心的场景下副本调度均衡

eg:
[tikv_servers]
tikv-1  ansible_host=x.x.x.x  deploy_dir=/xxx/xxx tikv_port=20160 tikv_status_port=20180             labels=&quot;zone=xxx,rack=xxx,host=xxx&quot;</code></pre></li>
<li><p>全局配置</p>
<pre><code>1.部署路径，默认的安装及日志存储路径：
    deploy_dir = XXXX
2.是否开启binlog：
    enable_binlog = False
3.指定版本，下载各组件时根据这一项的配置拉取文件
    tidb_version = v3.0.3</code></pre></li>
</ul>
</li>
<li><p>conf/tikv.toml 配置指定每个kv实例基础配置，比如对资源的利用限制，特殊存储引擎设置，日志相关设置等<br>  详细配置请戳：<a href="https://pingcap.com/docs-cn/v3.0/reference/performance/tune-tikv/#%E5%8F%82%E6%95%B0%E8%AF%B4%E6%98%8E" target="_blank" rel="noopener">tikv参数调优</a>    </p>
</li>
</ul>
<table>
<thead>
<tr>
<th align="center">常用配置项</th>
<th align="center">类型</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">sysnc-log</td>
<td align="center">bool</td>
<td align="left">默认为 true，表示强制将数据刷到磁盘上。如果是非金融安全级别的业务场景，建议设置成 false，以便获得更高的性能</td>
</tr>
<tr>
<td align="center">info-log-size</td>
<td align="center">string</td>
<td align="left">日志大小上线，eg: 1GB</td>
</tr>
<tr>
<td align="center">info-log-num</td>
<td align="center">int</td>
<td align="left">日志保留个数，eg: 20</td>
</tr>
</tbody></table>
<ul>
<li>conf/tidb.toml 配置指定每个db实例基础配置，比如对资源的利用限制，安全设置，协议层设置，日志相关设置等。tidb的设置跟tikv，binlog等配置紧密相关，关联到上层服务接入，下游数据消费等，根据适用场景调整。详细配置说明请戳：<a href="https://pingcap.com/search/docs-cn/v3.0/?q=tidb.toml" target="_blank" rel="noopener">tidb调优</a></li>
</ul>
<ul>
<li><p>group_vars/all.yml 全局配置，各组件默认端口号，日志相关设置等</p>
</li>
<li><p>安装部署启动三个剧本，按照ansible-playbook的编剧模式依次演出</p>
<pre><code>1.local_prepare.yml，下载各组件
2.bootstrap.yml，参数调整，基准条件测试，如果是测试环境，机器配置不能满足线上标准配置，可以调整剧本的测试选项跳过
3.deploy.yml，按照配置剧本指定项通过中控机生成各路文件及脚本
4.start.yml，启动整个集群</code></pre></li>
<li><p>第一次启动后，调整db实例配置，完成部署</p>
<pre><code>1.设置GC时间，决定可以数据闪回的时间上限制
    update mysql.tidb set VARIABLE_VALUE=&quot;24h&quot; where VARIABLE_NAME=&quot;tikv_gc_life_time&quot;;
2.初始化用户，跟其他数据库一样，最基础的安全防护
3.备份配置或者不配置，从心就好</code></pre></li>
<li><p>检查监控图及告警配置，根据每家公司的基础服务配置调整</p>
</li>
</ul>
<h3 id="3-常驻嘉宾tips"><a href="#3-常驻嘉宾tips" class="headerlink" title="3.常驻嘉宾tips"></a>3.常驻嘉宾tips</h3><h4 id="3-1-升级集群"><a href="#3-1-升级集群" class="headerlink" title="3.1 升级集群"></a>3.1 升级集群</h4><ul>
<li><p>对比配置文件项差异</p>
</li>
<li><p>注意inventory.ini文件中的版本标示</p>
</li>
<li><p>common_tasks/add_evict_leader_scheduler.yml </p>
<pre><code>storage调度leader策略配置，如果是线上环境，建议调大retries次数，
避免leader还没有调度结束的kv节点在滚动过程中被强制起停</code></pre></li>
<li><p>2个剧本需要注意</p>
<pre><code>1.local_prepare.yml 下载指定版本的文件
2.rolling_update.yml 2.X系列升级3.X系列需要使用excessive_rolling_update.yml，
也可以指定tags来滚动更新特定组建的配置</code></pre></li>
<li><p>别忘记监控一起滚呀滚</p>
</li>
</ul>
<h4 id="3-2-扩容-缩容组件"><a href="#3-2-扩容-缩容组件" class="headerlink" title="3.2.扩容/缩容组件"></a>3.2.扩容/缩容组件</h4><p>按照官方文档一步一步走即可，不要着急，不要放过任何一个报错</p>
<ul>
<li><p>扩容/缩容 tidb/tikv组件 修改inventory.ini指定项，-l指定项部署及启动即可</p>
</li>
<li><p>扩容/缩容 pd组件需要单独操作，因为涉及到这个集群的调度管理，保证pd实例节点数量奇数存活。</p>
<ul>
<li><p>扩容pd节点，inventory.ini 添加新的pd节点，deploy指定部署新增节点后，修改该节点的启动文件,将新增pd节点添加到当前集群</p>
<pre><code>1.编辑新增节点的启动文件 {deploy_dir}/scripts/run_pd.sh
    1.1.移除 --initial-cluster=&quot;xxxx&quot;
    1.3.添加 --join=&quot;http://xx.xx.xx.xx:2379&quot;
2.启动该节点
3.滚动整个集群及监控，更新元数据信息</code></pre></li>
<li><p>缩容pd节点</p>
<pre><code>1.通过pd-ctl工具下线pd节点pd-pd41，pd-ctl -u &quot;http://xx.xx.xx.xx:2379&quot; -d member delete name pd_pd41
2.ansible-playbook stop.yml -l pd41 #指定停止要下线的pd节点
3.inventory.ini 删除要先下线的pd节点
4.滚动整个集群及监控，更新元数据信息</code></pre></li>
</ul>
</li>
</ul>
<h3 id="4-监控指南"><a href="#4-监控指南" class="headerlink" title="4.监控指南"></a>4.监控指南</h3><ul>
<li><p>overview 面板，集群概况，各组件主要信息状态</p>
<ul>
<li>Services Port Status，各组件状态，异常么有显示具体组件地址，结合告警信息查看</li>
<li>PD，集群容量，region 基本健康状态信息</li>
<li>TiDB，db组件状态，直接反映集群对外提供服务的健康程度，QPS，Duration现象直观</li>
<li>TiKV，kv组件状态，存储层资源状态，容量使用情况等</li>
<li>System Info，服务器层概况，CPU，内存，IO，网络四大名捕</li>
</ul>
</li>
<li><p>根据告警或者应用的反馈情况，配合监控分类定位问题</p>
<ul>
<li>tikv-details面板<ul>
<li>写热点<ul>
<li>thread cpu &amp; raft store cpu</li>
<li>gRPC</li>
</ul>
</li>
<li>读热点<ul>
<li>gRPC，gRPC message count</li>
<li>coprocess，coprocess cpu &amp; scan keys</li>
</ul>
</li>
</ul>
</li>
<li>overview 面板<ul>
<li>事务冲突<ul>
<li>tidb，Lock Resolve OPS &amp; KV Backoff OPS</li>
</ul>
</li>
</ul>
</li>
<li>tikv-trouble-shooting面板，见闻知意</li>
</ul>
</li>
</ul>
<h3 id="5-友情客串tips"><a href="#5-友情客串tips" class="headerlink" title="5.友情客串tips"></a>5.友情客串tips</h3><ul>
<li><p>从哪里来</p>
<ul>
<li>从MySQL来，可以选择的交通方式有<ul>
<li>drianer</li>
<li>syncer</li>
<li>lighting</li>
<li>DM</li>
</ul>
</li>
<li>从Amazon Aurora来，可选择的交通方式有<ul>
<li>DM</li>
</ul>
</li>
<li>从CSV来，可选择的交通方式有<ul>
<li>lighting</li>
</ul>
</li>
</ul>
</li>
<li><p>到哪里去</p>
<ul>
<li>去MySQL/TiDB</li>
<li>去Kafka</li>
<li>去flash</li>
<li>去file</li>
</ul>
</li>
<li><p>我是谁</p>
<ul>
<li>TP主打</li>
<li>AP主打</li>
<li>需要跨数据中心</li>
</ul>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://sandysandy.github.io/2019/11/02/TiDB学习记录/" data-id="cl1bk392n0009pbtudvytfobe" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/TiDB/">TiDB</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2019/11/17/TiDB学习记录-监控入门/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          TiDB学习记录-监控入门
        
      </div>
    </a>
  
  
    <a href="/2019/10/08/TiDB配置文件/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">TiDB配置文件</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/MariaDB/">MariaDB</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mariadb/">Mariadb</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Meeting/">Meeting</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RDBMS/">RDBMS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RDBMS-MariaDB/">RDBMS,MariaDB</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TiDB/">TiDB</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vitess/">Vitess</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/MariaDB/" style="font-size: 10px;">MariaDB</a> <a href="/tags/Mariadb/" style="font-size: 10px;">Mariadb</a> <a href="/tags/Meeting/" style="font-size: 10px;">Meeting</a> <a href="/tags/RDBMS/" style="font-size: 10px;">RDBMS</a> <a href="/tags/RDBMS-MariaDB/" style="font-size: 10px;">RDBMS,MariaDB</a> <a href="/tags/TiDB/" style="font-size: 20px;">TiDB</a> <a href="/tags/Vitess/" style="font-size: 15px;">Vitess</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/03/">March 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2022/03/29/database-review-path-md/">database_review_path.md</a>
          </li>
        
          <li>
            <a href="/2019/11/21/Mariadb开发者大会2019记录/">Mariadb开发者大会2019记录</a>
          </li>
        
          <li>
            <a href="/2019/11/17/TiDB学习记录-数据迁移/">TiDB学习记录-数据迁移</a>
          </li>
        
          <li>
            <a href="/2019/11/17/TiDB学习记录-监控入门/">TiDB学习记录-监控入门</a>
          </li>
        
          <li>
            <a href="/2019/11/02/TiDB学习记录/">TiDB学习记录</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2022 ZhangWen<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>